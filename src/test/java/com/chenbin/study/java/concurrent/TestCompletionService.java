package com.chenbin.study.java.concurrent;import java.util.Random;import java.util.concurrent.Callable;import java.util.concurrent.CompletionService;import java.util.concurrent.ExecutionException;import java.util.concurrent.ExecutorCompletionService;import java.util.concurrent.ExecutorService;import java.util.concurrent.Executors;import java.util.concurrent.Future;import java.util.concurrent.TimeUnit;public class TestCompletionService {  public static final ExecutorService executorService = Executors.newCachedThreadPool();  public static final CompletionService<Integer> completionService = new ExecutorCompletionService<Integer>(      executorService);  public static void main(String[] args) {    int threadNum = 3;    for (int i = 1; i <= threadNum; i++) {      final int parentNum = i;      new Thread(() -> {        try {          completionServiceCount(parentNum);        } catch (InterruptedException e) {          e.printStackTrace();        } catch (ExecutionException e) {          e.printStackTrace();        }      }).start();    }  }  /**   * 使用completionService收集callable结果   */  public static void completionServiceCount(int parentNum)      throws InterruptedException, ExecutionException {    int threadNum = 3;    for (int i = 0; i < threadNum; i++) {      completionService.submit(getTask(i, parentNum));    }    Long start = System.currentTimeMillis();    int firstResult = completionService.take().get();    System.out.println(        "Parent thread num: " + parentNum + ", completionService first result: " + firstResult            + ", Cost time: " + (            System.currentTimeMillis() - start));    int secondResult = completionService.take().get();    System.out.println(        "Parent thread num: " + parentNum + ", completionService second result: " + secondResult            + ", Cost time: " + (            System.currentTimeMillis() - start));    Future<Integer> thirdFuture = completionService.poll(1000, TimeUnit.MILLISECONDS);    if (null != thirdFuture) {      int thirdResult = thirdFuture.get();      System.out.println(          "Parent thread num: " + parentNum + ", completionService third result: " + thirdResult              + ", Cost time: " + (              System.currentTimeMillis() - start));    } else {      System.out.println("Parent thread num: " + parentNum + ", completionService third failed!!!");    }//    int sum = 0;//    int temp = 0;//    for (int i = 0; i < threadNum; i++) {//      temp = completionService.take().get();//      sum += temp;//      System.out.print(temp + "\t");//    }//    System.out.println("CompletionService all is : " + sum);    executorService.shutdown();  }  public static Callable<Integer> getTask(final int no, final int parentNum) {    final Random rand = new Random();    Callable<Integer> task = new Callable<Integer>() {      @Override      public Integer call() throws Exception {        int time = rand.nextInt(100) * 100;        Thread.sleep(time);//        System.out.println(//            "Parent thread num: " + parentNum + ", current thread num: " + no + " time is: " + time);        return parentNum;      }    };    return task;  }}